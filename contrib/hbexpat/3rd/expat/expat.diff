diff --strip-trailing-cr -urN expat.orig/xmlparse.c expat/xmlparse.c
--- expat.orig/xmlparse.c	2017-07-12 21:55:49.000000000 +0000
+++ expat/xmlparse.c	2017-07-19 15:07:12.000000000 +0000
@@ -25,7 +25,12 @@
 
 #define XML_BUILDING_EXPAT 1
 
-#ifdef _WIN32
+#ifdef HARBOUR_CONF
+#include "_hbconf.h"
+#include "hbarc4.h"
+#define HAVE_ARC4RANDOM_BUF
+#define arc4random_buf(x, y) hb_arc4random_buf(x, y)
+#elif defined(_WIN32)
 #include "winconfig.h"
 #elif defined(HAVE_EXPAT_CONFIG_H)
 #include <expat_config.h>
@@ -773,6 +778,7 @@
 #endif  /* defined(HAVE_GETRANDOM) || defined(HAVE_SYSCALL_GETRANDOM) */
 
 
+#if ! defined(HAVE_ARC4RANDOM_BUF)
 #ifdef _WIN32
 
 typedef BOOLEAN (APIENTRY *RTLGENRANDOM_FUNC)(PVOID, ULONG);
@@ -828,6 +834,7 @@
   return tv.tv_usec;
 #endif
 }
+#endif  /* ! defined(HAVE_ARC4RANDOM_BUF) */
 
 static unsigned long
 ENTROPY_DEBUG(const char * label, unsigned long entropy) {
@@ -846,8 +853,7 @@
 {
   unsigned long entropy;
   (void)parser;
-#if defined(HAVE_ARC4RANDOM_BUF) || defined(__CloudABI__)
-  (void)gather_time_entropy;
+#if defined(HAVE_ARC4RANDOM_BUF)
   arc4random_buf(&entropy, sizeof(entropy));
   return ENTROPY_DEBUG("arc4random_buf", entropy);
 #else
diff --strip-trailing-cr -urN expat.orig/xmlrole.c expat/xmlrole.c
--- expat.orig/xmlrole.c	2017-07-12 21:55:49.000000000 +0000
+++ expat/xmlrole.c	2017-07-14 19:45:35.000000000 +0000
@@ -4,7 +4,9 @@
 
 #include <stddef.h>
 
-#ifdef _WIN32
+#ifdef HARBOUR_CONF
+#include "_hbconf.h"
+#elif defined(_WIN32)
 #include "winconfig.h"
 #else
 #ifdef HAVE_EXPAT_CONFIG_H
diff --strip-trailing-cr -urN expat.orig/xmltok.c expat/xmltok.c
--- expat.orig/xmltok.c	2017-07-12 21:55:49.000000000 +0000
+++ expat/xmltok.c	2017-07-14 19:45:35.000000000 +0000
@@ -4,7 +4,9 @@
 
 #include <stddef.h>
 
-#ifdef _WIN32
+#ifdef HARBOUR_CONF
+#include "_hbconf.h"
+#elif defined(_WIN32)
 #include "winconfig.h"
 #else
 #ifdef HAVE_EXPAT_CONFIG_H
